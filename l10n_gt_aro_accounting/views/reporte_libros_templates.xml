<odoo>
    <template id="reporte_libros_pdf_template">
        <t t-call="web.html_container">
            <!-- Usamos external_layout para aprovechar el soporte de páginas -->
            <t t-call="web.basic_layout">
                <t t-set="o" t-value="docs[0]"/>
                <t t-set="tipo_libro" t-value="libro"/>
                
                <!-- Ocultar el encabezado y pie de página predeterminados de Odoo -->
                <style>
                    .o_report_layout_standard > header, 
                    .o_report_layout_standard > footer,
                    .o_report_layout_background > header,
                    .o_report_layout_background > footer,
                    .o_standard_footer {
                        display: none !important;
                    }
                    
                    /* Estilos para la tabla */
                    .text-small { font-size: 10px; }
                    .table th, .table td { padding: 2px !important; font-size: 9px; }
                    .summary-table { margin-top: 10px; width: 100%; font-size: 9px; }
                    
                    /* Estilos para el encabezado personalizado */
                    .libro-header {
                        border-bottom: 1px solid #ddd;
                        padding-bottom: 8px;
                        margin-bottom: 10px;
                        width: 100%;
                    }
                    
                    .folio-box {
                        border: 1px solid #000;
                        padding: 2px 8px;
                        font-weight: bold;
                        float: right;
                    }
                    
                    /* Control para evitar saltos de página dentro de filas */
                    .invoice-table tr {
                        page-break-inside: avoid;
                    }
                </style>
                
                <!-- División por grupos de 20 líneas para mejor control de paginación -->
                <t t-set="lines_per_chunk" t-value="20"/>
                <t t-set="chunks" t-value="[lines[i:i+lines_per_chunk] for i in range(0, len(lines), lines_per_chunk)]"/>
                <t t-set="current_folio" t-value="o.folio_inicial"/>
                
                <!-- Iterar por cada grupo (chunk) de líneas -->
                <t t-foreach="chunks" t-as="chunk">
                    <!-- Para el segundo chunk en adelante, forzar salto de página -->
                    <div t-if="not chunk_first" style="page-break-before: always;"></div>
                    
                    <!-- Encabezado personalizado para cada página -->
                    <div class="libro-header text-small">
                        <div class="folio-box">
                            Folio: <span t-esc="current_folio"/>
                        </div>
                        <div>
                            <p>Valor de tipo_libro: <t t-esc="repr(tipo_libro)"/></p>
                            <strong t-if="tipo_libro == 'compras'">LIBRO DE COMPRAS Y SERVICIOS RECIBIDOS</strong>
                            <strong t-if="tipo_libro == 'ventas'">LIBRO DE VENTAS Y SERVICIOS PRESTADOS</strong>
                            <strong><t t-esc="o.company_id.name"/></strong><br/>
                            <span><strong>Número de identificación tributaria:</strong> <t t-esc="o.company_id.vat"/></span><br/>
                            <span><strong>Nombre comercial:</strong> <t t-esc="o.company_id.name"/></span><br/>
                            <span><strong>Domicilio fiscal:</strong> <t t-esc="o.company_id.street"/></span><br/>
                            <span><strong>Registro del:</strong> <t t-esc="o.date_start"/> al <t t-esc="o.date_end"/></span>
                        </div>
                    </div>
                    
                    <table class="table table-sm table-bordered invoice-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Serie</th>
                                <th>Número</th>
                                <th>NIT</th>
                                <th>Compañía</th>
                                <th class="text-right">Bien.</th>
                                <th class="text-right">Bien. Ex.</th>
                                <th class="text-right">Serv.</th>
                                <th class="text-right">Serv. Ex.</th>
                                <th class="text-right">Comb.</th>
                                <th class="text-right">Comb. Ex.</th>
                                <th class="text-right">Impo.</th>
                                <th class="text-right">Impo. Exe.</th>
                                <th class="text-right">Peq.</th>
                                <th class="text-right">IVA</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="index" t-value="chunks.index(chunk) * lines_per_chunk + 1"/>
                            <t t-foreach="chunk" t-as="line">
                                <tr>
                                    <td><t t-esc="index"/></td>
                                    <td><t t-esc="line.get('tipo')"/></td>
                                    <td><t t-esc="line.get('fecha')"/></td>
                                    <td><t t-esc="line.get('serie')"/></td>
                                    <td><t t-esc="line.get('numero')"/></td>
                                    <td><t t-esc="line.get('nit')"/></td>
                                    <td><t t-esc="line.get('compania')"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['bienes'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['bienes_exento'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['servicios'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['servicios_exento'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['combustible'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['combustible_exento'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['importacion'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['importacion_exento'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['peq'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['iva'])"/></td>
                                    <td class="text-right"><t t-esc="'{:,.2f}'.format(line['resumen']['total'])"/></td>
                                </tr>
                                <t t-set="index" t-value="index + 1"/>
                            </t>
                        </tbody>
                    </table>
                    
                    <!-- Incrementar el folio para la siguiente página -->
                    <t t-set="current_folio" t-value="current_folio + 1"/>
                </t>
                
                <!-- Página de resumen -->
                <div style="page-break-before: always;"></div>
                
                <!-- Encabezado para la página de resumen -->
                <div class="libro-header text-small">
                    <div class="folio-box">
                        Folio: <span t-esc="current_folio"/>
                    </div>
                    <div>
                        <strong><t t-esc="o.company_id.name"/></strong><br/>
                        <span><strong>Número de identificación tributaria:</strong> <t t-esc="o.company_id.vat"/></span><br/>
                        <span><strong>Nombre comercial:</strong> <t t-esc="o.company_id.name"/></span><br/>
                        <span><strong>Domicilio fiscal:</strong> <t t-esc="o.company_id.street"/></span><br/>
                        <span><strong>Registro del:</strong> <t t-esc="o.date_start"/> al <t t-esc="o.date_end"/></span>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Resumen Global</h4>
                <p style="margin-bottom: 10px;">
                    <strong>Cantidad de Facturas:</strong> <span t-esc="summary.get('count', 0)"/>
                </p>
                <table class="summary-table table-bordered">
                    <thead>
                        <tr>
                            <th>Categoría</th>
                            <th class="text-right">Base</th>
                            <th class="text-right">IVA</th>
                            <th class="text-right">Exento</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="categorias" t-value="['bienes', 'servicios', 'combustible', 'importacion', 'peq']"/>
                        <t t-set="total_base" t-value="0"/>
                        <t t-set="total_iva" t-value="0"/>
                        <t t-set="total_exento" t-value="0"/>
                        <t t-set="total_total" t-value="0"/>
                        <t t-foreach="categorias" t-as="cat">
                            <tr>
                                <td><t t-esc="cat.title()"/></td>
                                <td class="text-right"><t t-set="base" t-value="summary.get(cat, {}).get('base', 0)"/><t t-esc="'{:,.2f}'.format(base)"/></td>
                                <td class="text-right"><t t-set="iva" t-value="summary.get(cat, {}).get('iva', 0)"/><t t-esc="'{:,.2f}'.format(iva)"/></td>
                                <td class="text-right"><t t-set="exento" t-value="summary.get(cat, {}).get('exento', 0)"/><t t-esc="'{:,.2f}'.format(exento)"/></td>
                                <td class="text-right"><t t-set="total" t-value="summary.get(cat, {}).get('total', 0)"/><t t-esc="'{:,.2f}'.format(total)"/></td>
                                <t t-set="total_base" t-value="total_base + base"/>
                                <t t-set="total_iva" t-value="total_iva + iva"/>
                                <t t-set="total_exento" t-value="total_exento + exento"/>
                                <t t-set="total_total" t-value="total_total + total"/>
                            </tr>
                        </t>
                        <tr>
                            <td><strong>Total General</strong></td>
                            <td class="text-right"><strong><t t-esc="'{:,.2f}'.format(total_base)"/></strong></td>
                            <td class="text-right"><strong><t t-esc="'{:,.2f}'.format(total_iva)"/></strong></td>
                            <td class="text-right"><strong><t t-esc="'{:,.2f}'.format(total_exento)"/></strong></td>
                            <td class="text-right"><strong><t t-esc="'{:,.2f}'.format(total_total)"/></strong></td>
                        </tr>
                    </tbody>
                </table>
            </t>
        </t>
    </template>
</odoo>
